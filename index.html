<script>
    const fxContainer = document.getElementById('fx-container');
    // HÓESÉS
    for(let i=0; i<200; i++){
        let flake = document.createElement('div');
        flake.className = 'snowflake';
        flake.style.left = Math.random() * 100 + 'vw';
        let size = Math.random() * 3 + 1;
        flake.style.width = size + 'px'; flake.style.height = size + 'px';
        flake.style.animationDuration = (Math.random() * 5 + 3) + 's';
        flake.style.filter = `blur(${Math.random()}px)`;
        flake.style.opacity = Math.random() * 0.7 + 0.3;
        fxContainer.appendChild(flake);
    }

    // --- ADATGENERÁLÁS ---
    const gpsData = [];
    const leopards = ['Dagina', 'Presnel', 'Kheshig', 'Aztai', 'Nachin'];
    const bases = {
        'Dagina':  {lat: 43.1, lon: 100.4}, 'Presnel': {lat: 42.9, lon: 99.1},
        'Kheshig': {lat: 43.5, lon: 101.2}, 'Aztai':   {lat: 43.8, lon: 98.7},
        'Nachin':  {lat: 42.4, lon: 100.9}
    };
    for(let i=0; i<1000; i++) {
        const leo = leopards[Math.floor(Math.random() * leopards.length)];
        const base = bases[leo];
        // Kicsit nagyobb szórás, hogy jobban mutasson
        gpsData.push({
            Latitude: base.lat + (Math.random() - 0.5) * 0.6,
            Longitude: base.lon + (Math.random() - 0.5) * 0.6,
            Leopard_ID: leo
        });
    }

    const dietData = [
        {category: "Kék Juh (Bharal)", value: 55}, {category: "Kőszáli Kecske", value: 20},
        {category: "Mormota & Kisemlős", value: 7}, {category: "Háziállat (Konfliktus)", value: 18}
    ];

    const elevationData = [
        {honap: "Jan", magassag: 2800}, {honap: "Feb", magassag: 2900}, {honap: "Már", magassag: 3200}, {honap: "Ápr", magassag: 3600},
        {honap: "Máj", magassag: 4100}, {honap: "Jún", magassag: 4500}, {honap: "Júl", magassag: 4600}, {honap: "Aug", magassag: 4400},
        {honap: "Szep", magassag: 4000}, {honap: "Okt", magassag: 3500}, {honap: "Nov", magassag: 3000}, {honap: "Dec", magassag: 2800}
    ];

    const commonConfig = { actions: false, background: "transparent", theme: "dark" };

    // --- SPEC 1: TÉRKÉP (EGÉR ZOOM & PAN) ---
    const spec1 = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "width": "container", "height": 500, "background": "transparent",
        "params": [
            { "name": "zoom", "value": 400, "on": [{ "events": {"type": "wheel", "consume": true}, "update": "clamp(zoom * pow(1.001, -event.deltaY), 150, 3000)" }] },
            { "name": "clon", "value": 85, "on": [{ "events": {"type": "mousemove", "consume": true, "between": [{"type": "mousedown"}, {"type": "mouseup"}]}, "update": "clon - (event.movementX / (zoom / 100))" }] },
            { "name": "clat", "value": 40, "on": [{ "events": {"type": "mousemove", "consume": true, "between": [{"type": "mousedown"}, {"type": "mouseup"}]}, "update": "clat + (event.movementY / (zoom / 100))" }] }
        ],
        "projection": { "type": "mercator", "scale": {"signal": "zoom"}, "center": [{"signal": "clon"}, {"signal": "clat"}] },
        "layer": [
            { "data": { "url": "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json", "format": { "type": "topojson", "feature": "countries" } }, "mark": { "type": "geoshape", "fill": "#233456", "stroke": "#4a6fa5", "strokeWidth": 1 } },
            {
                "data": { "url": "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json", "format": { "type": "topojson", "feature": "countries" } },
                "transform": [
                    { "lookup": "id", "from": { "data": { "url": "snow_leopard_extended.csv" }, "key": "id", "fields": ["Populacio_Becsles", "Orszag", "Elohely_Minoseg_Pontszam"] } },
                    { "filter": "datum.Populacio_Becsles != null" }
                ],
                "mark": { "type": "geoshape", "stroke": "white", "strokeWidth": 0.5, "cursor": "pointer" },
                "encoding": {
                    "color": { "field": "Populacio_Becsles", "type": "quantitative", "scale": { "scheme": "tealblues" }, "legend": { "title": "Populáció", "titleColor": "#aed9e0", "labelColor": "#fff" } },
                    "tooltip": [ {"field": "Orszag", "title": "Ország"}, {"field": "Populacio_Becsles", "title": "Becsült Egyedszám"} ]
                }
            }
        ]
    };

    // --- SPEC 2: GPS (JAVÍTOTT SKÁLA!) ---
    const spec2 = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "width": "container", "height": 400, "data": { "values": gpsData },
        "mark": { "type": "circle", "size": 60, "opacity": 0.6 },
        "encoding": {
            "x": { 
                "field": "Longitude", 
                "type": "quantitative", 
                "scale": {"zero": false}, // <--- FONTOS! Ne 0-tól induljon
                "axis": {"gridColor": "#334", "labelColor": "#fff", "title": "Hosszúság"} 
            },
            "y": { 
                "field": "Latitude", 
                "type": "quantitative", 
                "scale": {"zero": false}, // <--- FONTOS! Ne 0-tól induljon
                "axis": {"gridColor": "#334", "labelColor": "#fff", "title": "Szélesség"} 
            },
            "color": { "field": "Leopard_ID", "type": "nominal", "scale": {"scheme": "set2"}, "legend": {"titleColor": "#aed9e0", "labelColor": "#fff", "title": "Párduc"} },
            "tooltip": [{"field": "Leopard_ID", "title": "Név"}]
        },
        "params": [{ "name": "grid", "select": "interval", "bind": "scales" }]
    };

    // --- SPEC 3: GAZDASÁG ---
    const spec3 = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "width": "container", "height": 400, "data": { "url": "leopard_economy.csv" },
        "encoding": { "x": { "field": "Ev", "type": "ordinal", "title": "Év", "axis": {"labelColor": "#fff", "grid": false} } },
        "layer": [
            { "mark": {"type": "line", "stroke": "#00d2ff", "strokeWidth": 4, "point": true}, "encoding": { "y": { "field": "Turizmus_Bevetel_USD", "type": "quantitative", "title": "Turizmus ($)", "axis": {"titleColor": "#00d2ff", "labelColor": "#00d2ff", "gridColor": "#334"} }, "tooltip": [{"field": "Ev"}, {"field": "Turizmus_Bevetel_USD"}] } },
            { "mark": {"type": "line", "stroke": "#ff6b6b", "strokeWidth": 4, "point": true}, "encoding": { "y": { "field": "Orvvadaszat_Esetek", "type": "quantitative", "title": "Orvvadászat (db)", "axis": {"titleColor": "#ff6b6b", "labelColor": "#ff6b6b", "grid": false, "orient": "right"} }, "tooltip": [{"field": "Ev"}, {"field": "Orvvadaszat_Esetek"}] } }
        ], "resolve": {"scale": {"y": "independent"}}
    };

    // --- SPEC 4: TÁPLÁLÉK (SÁV) ---
    const spec4 = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "width": "container", "height": 400, 
        "data": { "values": dietData },
        "mark": { "type": "bar", "cornerRadiusEnd": 4, "height": {"band": 0.5} },
        "encoding": {
            "x": { "field": "value", "type": "quantitative", "title": "Arány (%)", "axis": {"gridColor": "#334", "labelColor": "#fff"} },
            "y": { "field": "category", "type": "nominal", "sort": "-x", "title": null, "axis": {"labelColor": "#fff", "labelFontSize": 12} },
            "color": { "field": "category", "type": "nominal", "scale": {"range": ["#00d2ff", "#ff6b6b", "#2980b9", "#aed9e0"]}, "legend": null },
            "tooltip": [ {"field": "category", "title": "Zsákmány"}, {"field": "value", "title": "Százalék"} ]
        }
    };

    // --- SPEC 5: MAGASSÁG (JAVÍTOTT SKÁLA!) ---
    const spec5 = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "width": "container", "height": 400, "data": { "values": elevationData },
        "mark": { 
            "type": "area", 
            "line": { "color": "#00d2ff" }, 
            "color": { 
                "x1": 1, "y1": 1, "x2": 1, "y2": 0, 
                "gradient": "linear", 
                "stops": [ {"offset": 0, "color": "rgba(0, 210, 255, 0.6)"}, {"offset": 1, "color": "rgba(0, 210, 255, 0.1)"} ] 
            } 
        },
        "encoding": {
            "x": { "field": "honap", "type": "ordinal", "sort": null, "title": null, "axis": {"labelColor": "#fff", "grid": false} },
            "y": { 
                "field": "magassag", 
                "type": "quantitative", 
                "title": "Magasság (m)", 
                "scale": {"domain": [2000, 5000], "zero": false}, // <--- FONTOS!
                "axis": {"gridColor": "#334", "labelColor": "#fff"} 
            },
            "tooltip": [ {"field": "honap", "title": "Hónap"}, {"field": "magassag", "title": "Magasság"} ]
        }
    };

    vegaEmbed('#viz1', spec1, commonConfig);
    vegaEmbed('#viz4', spec4, commonConfig);
    vegaEmbed('#viz5', spec5, commonConfig);
    vegaEmbed('#viz2', spec2, commonConfig);
    vegaEmbed('#viz3', spec3, commonConfig);
</script>
